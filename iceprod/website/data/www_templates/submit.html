{% extends "base.html" %}

{% autoescape None %}

{% block title %}IceProd Config{% if dataset %} Dataset {{ dataset }}{% end %}{% end %}

{% block head_scripts %}
<link rel="stylesheet" href="/static/submit.css" media="all" type="text/css" />
<link rel="stylesheet" href="/static/documentation.css" media="all" type="text/css" />
{% end %}

{% block page_title %}{% if dataset_id %}{% if edit %}Edit{% else %}View{% end %} Config - <a href="/dataset/{{ dataset_id }}">Dataset {{ dataset }}</a>{% else %}Submit{% end %}{% end %}

{% block sidebar %}
<div class="section macro_box">
    <h3>Macros</h3>
    <ul>
        <li>
            <h4>$(dataset_id)</h4>
            <p class="macro_desc">The dataset_id string.</p>
        </li>
        <li>
            <h4>$(dataset)</h4>
            <p class="macro_desc">The dataset_id in numerical form.</p>
        </li>
        <li>
            <h4>$(jobs_submitted)</h4>
            <p class="macro_desc">The number of jobs in the dataset.</p>
        </li>
        <li>
            <h4>$(job)</h4>
            <p class="macro_desc">The job index within the dataset.</p>
        </li>
        <li>
            <h4>$(task_id)</h4>
            <p class="macro_desc">The task_id string.</p>
        </li>
        <li>
            <h4>$(task)</h4>
            <p class="macro_desc">The task name.</p>
        </li>
    </ul>
</div>
{% end %}

{% block body %}
{% set view_only = bool(dataset_id and not edit) %}
<div id="submit_area">
    {% if not view_only %}
    <form method="post" action="/{% if edit %}config{% else %}submit{% end %}" autocomplete="off">
        {% module xsrf_form_html() %}
    {% end %}
        <textarea name="submit_box" id="submit_box" style="min-height: 500px" autofocus{% if view_only %} readonly{% end %}>{{ config }}</textarea>
        <textarea name="description" id="description" placeholder="Description"{% if view_only %} readonly{% end %}>{{ description }}</textarea>
        <div class="submit_contents">
            {% if dataset_id %}
            <input type="hidden" name="dataset_id" value="{{ dataset_id }}" />
            <input type="hidden" name="edit" value="{{ edit }}" />
                {% if edit %}
            <button id="submit_action">Update</button>
                {% end %}
            {% else %}
            Number of jobs:
            <input name="number_jobs" id="number_jobs" value="{{ jobs_submitted }}" min="1" max="1000000" step="1" type="number">
            Group:
            <select name="group" id="group">
                {% for g in groups %}
                    <option value="{{ g }}" {% if g == group %}selected{% end %}>{{ g }}</option>
                {% end %}
            </select>
            <button id="submit_action">Submit</button>
            {% end %}
        </div>
    {% if not view_only %}
    </form>
    {% end %}
</div>
<div id="error">{{ error }}</div>
{% end %}

{% block body_scripts %}
<script src="/static/fetch.js"></script>
<script type="text/javascript" src="/static/rest.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv2020.bundle.min.js" integrity="sha512-mXlpzWzZB+t4DFFezQkpSiCbT8aW12t688aLsd6KGNbRWDOdCur5C6Fl0rDl75VruBy42GvWsd6F35VQcs3lwQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
const edit = {{ json_encode(edit) }};
const dataset_id = '{{ dataset_id }}';

var dataset_schemas = {};

function validator(config) {
    try {
        // figure out schema
        const ver = config['version'].toString();
        if (!(ver in dataset_schemas)) {
            $('#error').text('Error validating config: '+error);
            return false;
        }
        // validate
        const ajv = new ajv2020({useDefaults: true});
        const validate = ajv.compile(dataset_schemas[ver]);
        const valid = validate(config)
        if (!valid) {
            throw new Error(validate.errors[0].instancePath+' - '+validate.errors[0].message);
        }
    } catch (error) {
        $('#error').text('Error validating config: '+error);
        return false;
    }
    return true;
}
function parse_json(config){
    try {
        return JSON.parse(config);
    } catch (err) {
        $('#error').text(err);
        return null;
    }
}

{% if not (dataset_id and not edit) %}
async function get_dataset_schema(version) {
    try {
        const ret = await fetch('/schemas/v3/dataset_v'+version+'.schema.json');
        if (!ret.ok) {
            throw new Error('Response status: '+ret.status);
        }
        const schema = await ret.json();
        dataset_schemas[version] = schema;
    } catch (error) {
        $('#error').text('Error downloading json schema: '+error.message);
        return false;
    }
}
{% from iceprod.core.config import ConfigSchema %}
{% for ver in ConfigSchema.list_versions() %}
get_dataset_schema('{{ ver }}');
{% end %}

const submit_box = $('#submit_box');
const description = $('#description');
submit_box.on('input', (event) => {
    submit_box[0].setCustomValiditiy("");
    const submit_data = parse_json(submit_box.val());
    if (!submit_box[0].validity.valid) {
        return;
    }
    if (submit_data == null) {
        submit_box[0].setCustomValidity("Cannot parse JSON");
    }
    if (!validator(submit_data)) {
        submit_box[0].setCustomValidity("Cannot validate config");
    }
})
$('form').on("submit", (event) => {
    if (!submit_box[0].validity.valid || !description[0].validity.valid) {
        // prevent form submission
        event.preventDefault();
    }
});
{% end %}
</script>
{% end %}
