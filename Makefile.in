
# @configure_input@

# some default variables
PREFIX=@prefix@
CC=@CC@
CFLAGS=@CFLAGS@
CPPFLAGS=@CPPFLAGS@
CXX=@CXX@
CXXFLAGS=@CXXFLAGS@
AWK=@AWK@
SED=@SED@
GREP=@GREP@
SHELL=@SHELL@
srcdir=@srcdir@
VPATH=@srcdir@

NULL:=
SPACE:= $(NULL) 


# custom variables
PLATFORM=@platform@
WWW=@www@
WWWFLAGS=@wwwflags@
TARBALL_NAME=@tarball_name@
CORE_TARBALL_NAME=core_@tarball_name@

# build packages
CONF_DEPS_URLS=ftp://ftp.gnu.org/gnu/libtool/libtool-2.4.2.tar.gz \
http://ftp.gnu.org/gnu/readline/readline-6.2.tar.gz \
http://www.openssl.org/source/openssl-1.0.1b.tar.gz \
ftp://xmlsoft.org/libxml2/libxml2-2.7.8.tar.gz \
ftp://xmlsoft.org/libxml2/libxslt-1.1.26.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/pcre-8.30.tar.gz \
http://curl.haxx.se/download/curl-7.25.0.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/expat-2.1.0.tar.gz \
http://www.cpan.org/src/5.0/perl-5.14.2.tar.gz \
http://www.python.org/ftp/python/2.7.3/Python-2.7.3.tgz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/nginxuploadmodule-2.2.0.tar.gz \
http://nginx.org/download/nginx-1.2.0.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/p7zip-9.20.1.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/globus-5.2.1.tar.gz


CONF_DEPS=$(foreach confdeps,$(notdir $(CONF_DEPS_URLS)),$(filter-out %.tar.gz %.tgz,$(subst -, ,$(confdeps))))

PYTHON_DEPS_URLS=http://x2100.icecube.wisc.edu/downloads/iceprod2/pyOpenSSL-0.11.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/apsw-3.7.11.tar.gz \
http://pypi.python.org/packages/source/l/lxml/lxml-2.3.4.tar.gz \
http://pycurl.sourceforge.net/download/pycurl-7.19.0.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/tornado-2.2.tar.gz \
http://pypi.python.org/packages/source/j/jsonrpclib/jsonrpclib-0.1.3.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/tornadorpc-2.0.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/pyuv-0.6.1.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/pyuvtornado-0.5.0.tar.gz \
http://x2100.icecube.wisc.edu/downloads/iceprod2/pygridftp-1.3.2.tar.gz \
http://pypi.python.org/packages/source/c/coverage/coverage-3.5.2.tar.gz

PYTHON_DEPS=$(foreach pythondeps,$(notdir $(PYTHON_DEPS_URLS)),$(filter-out %.tar.gz %.tgz,$(subst -, ,$(pythondeps))))

DEPS_URLS=$(CONF_DEPS_URLS) $(PYTHON_DEPS_URLS)

ICEPROD=iceprod-core iceprod-client iceprod-server iceprod-modules

# list only those that are needed for the iceprod core to run on remote nodes
CORE_DEPS=libtool readline openssl libxml2 libxslt pcre curl expat perl Python p7zip globus pyOpenSSL apsw lxml pycurl jsonrpclib
ICEPROD_CORE=iceprod-core iceprod-modules


# some useful functions
eq=$(and $(findstring $(1),$(2)),$(findstring $(2),$(1)))
getdirname=$(if $(findstring .tgz,$(1)),$(basename $(1)),$(basename $(basename $(1))))
getdepname=$(firstword $(subst -, ,$(1)))
geturi=$(foreach var,$(DEPS_URLS),$(if $(call eq,$(1),$(call getdepname,$(call getdirname,$(notdir $(var))))),$(var),))
getconfdir=$(call getdirname,$(notdir $(call geturi,$(1))))



# decide to do prebuilt binary or src build
.PHONY : all install build
ifeq (@prebuilt@,prebuilt)
# prebuilt binary should be available
all : 
ifeq ($(wildcard $(TARBALL_NAME)),)
	echo "binary tarball not found"
	exit 1
else
	echo "nothing to do"
endif
install : makeprefixdir
ifeq ($(wildcard $(TARBALL_NAME)),)
	echo "binary tarball not found"
	exit 1
else
	tar -zx -C $(PREFIX) -f $(TARBALL_NAME)
endif

core : 
ifeq ($(wildcard $(CORE_TARBALL_NAME),)
	echo "binary core_tarball not found"
	exit 1
else
	cp $(CORE_TARBALL_NAME) $(PREFIX)/$(CORE_TARBALL_NAME)
endif


else
# build from sources
all : build

install : build makeprefixdir install_build


build : $(addsuffix _download,$(CONF_DEPS) $(PYTHON_DEPS))

install_build : checkinstallhist exportvars $(addsuffix _configure,$(CONF_DEPS) $(PYTHON_DEPS)) iceprod_config misc_config

core : $(addsuffix _download,$(CORE_DEPS)) install_core
install_core : OLD_PREFIX := $(PREFIX)
install_core : PREFIX := $(PREFIX)_core
install_core : checkinstallcorehist exportvars $(addsuffix _configure,$(CORE_DEPS)) iceprod_config_core core_tarball

endif

define createinstallhist
 $(eval incmd:=$(if $(filter install%,$(MAKECMDGOALS)),YES,))
 $(eval lasthist:=$(if $(wildcard Makefile.hist),$(shell cat Makefile.hist),YES))
 $(eval hist:=$(if $(incmd),$(if $(call eq,lasthist,install),,installclean),))
 checkinstallhist : $(hist)
	echo install > Makefile.hist
endef
$(eval $(call createinstallhist))
define createinstallcorehist
 $(eval incmd:=$(if $(filter install%,$(MAKECMDGOALS)),YES,))
 $(eval lasthist:=$(if $(wildcard Makefile.hist),$(shell cat Makefile.hist),YES))
 $(eval hist:=$(if $(incmd),$(if $(call eq,lasthist,install_core),,installclean),))
 checkinstallcorehist : $(hist)
	echo install_core > Makefile.hist
endef
$(eval $(call createinstallcorehist))

ORIG_PATH:=$(PATH)
ORIG_LD_LIBRARY_PATH:=$(LD_LIBRARY_PATH)
ORIG_C_INCLUDE_PATH:=$(C_INCLUDE_PATH)
ORIG_LIBRARY_PATH:=$(LIBRARY_PATH)
ORIG_PERL5LIB:=$(PERL5LIB)
exportvars : 
	$(eval PATH:=$(PREFIX)/bin:$(ORIG_PATH))
	$(eval export PATH)
	$(eval LD_LIBRARY_PATH:=$(PREFIX)/lib:$(PREFIX)/lib64/:$(ORIG_LD_LIBRARY_PATH))
	$(eval export LD_LIBRARY_PATH)
	$(eval GLOBUS_LOCATION:=$(PREFIX))
	$(eval export GLOBUS_LOCATION)
	$(eval C_INCLUDE_PATH:=$(PREFIX)/include:$(ORIG_C_INCLUDE_PATH))
	$(eval LIBRARY_PATH:=$(PREFIX)/lib:$(PREFIX)/lib64:$(ORIG_LIBRARY_PATH))
	$(eval PERL5LIB:=$(PREFIX)/lib/perl:$(PREFIX)/lib/perl5:$(PREFIX)/lib/per5/site_perl:$(ORIG_PERL5LIB))
	$(eval export PERL5LIB)


makeprefixdir : 
	mkdir -p $(PREFIX)

tarball : 
	$(eval curdir:=$(PWD))
	cd $(PREFIX);tar -zcf $(curdir)/$(TARBALL_NAME) *

core_tarball :
	rm -rf $(PREFIX)/share/man $(PREFIX)/share/doc $(PREFIX)/share/gtk-doc $(PREFIX)/share/info $(PREFIX)/share/doxygen
	$(if $(wildcard $(OLD_PREFIX)),,mkdir -p $(OLD_PREFIX))
	cd $(PREFIX);tar -zcf $(OLD_PREFIX)/$(CORE_TARBALL_NAME) *
	rm -rf $(PREFIX)


clean : $(addsuffix _clean,$(CONF_DEPS))

installclean : $(addsuffix _installclean,$(CONF_DEPS))
	
distclean :
	rm -rf Makefile env-shell.sh 
	$(foreach var,$(CONF_DEPS) $(PYTHON_DEPS),rm -rf $(call getconfdir,$(var)) $(notdir $(call geturi,$(var)));)


# download commands are dynamically generated based on DEPS
define download_expand
 $(eval url = $(strip $(call geturi,$1)))
 $(eval file = $(notdir $(url)))
 $(eval dir = $(call getdirname,$(file)))
 $(file) : 
	$(WWW) $(WWWFLAGS) $(file) $(url)
 $(dir) : $(file)
	tar -zxf $(file);touch $(dir)
 $1_download : $(dir)
endef
$(eval $(foreach var,$(CONF_DEPS) $(PYTHON_DEPS),$(call download_expand,$(var))))


# general clean
%_clean :
	$(eval dirname:=$(call getconfdir,$(firstword $(subst _, ,$@))))
	-$(if $(wildcard $(dirname)/Makefile),cd $(dirname);$(MAKE) clean,)


# now list the build instructions for each dependency

libtool_configure : libtool_download $(call getconfdir,libtool)/Makefile
	cd $(call getconfdir,libtool);make;make install
$(call getconfdir,libtool)/Makefile : 
	cd $(call getconfdir,libtool);./configure --prefix=$(PREFIX)
libtool_installclean : 
	rm -rf $(call getconfdir,libtool)/Makefile

openssl_configure : openssl_download
	cd $(call getconfdir,openssl);./config --prefix=$(PREFIX) -fPIC;make;make install
openssl_installclean : 


readline_configure : readline_download $(call getconfdir,readline)/Makefile
	cd $(call getconfdir,readline);make;make install
$(call getconfdir,readline)/Makefile : 
	cd $(call getconfdir,readline);./configure --prefix=$(PREFIX)
readline_installclean : 
	-rm -rf $(call getconfdir,readline)/Makefile

expat_configure : expat_download $(call getconfdir,expat)/Makefile
	cd $(call getconfdir,expat);make;make install
$(call getconfdir,expat)/Makefile : 
	cd $(call getconfdir,expat);./configure --prefix=$(PREFIX)
expat_installclean : 
	-rm -rf $(call getconfdir,expat)/Makefile

# this is a globus dependency
# delete perl after building; configure script does not update
#  prefix if run multiple times
perl_configure : perl_download perl_core_config perl_extras_config
perl_core_config : 
	cd $(call getconfdir,perl);./Configure -des -Dprefix=$(PREFIX);make;make install
perl_extras_config : 
	echo $(PATH)
	cpan App:cpanminus
	cpanm Archive::Tar
	cpanm Compress::Zlib
	cpanm Digest::MD5
	cpanm File::Spec
	cpanm IO::Zlib
	cpanm Pod::Parser
	cpanm Test::Simple
	C_INCLUDE_PATH=$(C_INCLUDE_PATH) LIBRARY_PATH=$(LIBRARY_PATH) cpanm XML::Parser
perl_installclean : 
	-rm -rf $(call getconfdir,perl)


Python_configure : Python_download $(call getconfdir,Python)/Makefile 
	cd $(call getconfdir,Python);make;make install
$(call getconfdir,Python)/Makefile : 
	cd $(call getconfdir,Python);./configure --prefix=$(PREFIX) --enable-shared
Python_installclean : 
	-rm -rf $(call getconfdir,Python)/Makefile

libxml2_configure : libxml2_download $(call getconfdir,libxml2)/Makefile
	cd $(call getconfdir,libxml2);make;make install
$(call getconfdir,libxml2)/Makefile : 
	cd $(call getconfdir,libxml2);./configure --prefix=$(PREFIX) LDFLAGS=-L$(PREFIX)/lib/
libxml2_installclean : 
	-rm -rf $(call getconfdir,libxml2)/Makefile

libxslt_configure : libxslt_download $(call getconfdir,libxslt)/Makefile
	cd $(call getconfdir,libxslt);make;make install
$(call getconfdir,libxslt)/Makefile :
	cd $(call getconfdir,libxslt);./configure --prefix=$(PREFIX) LDFLAGS=-L$(PREFIX)/lib/
libxslt_installclean : 
	-rm -rf $(call getconfdir,libxslt)/Makefile

pcre_configure : pcre_download
	cd $(call getconfdir,pcre);./configure --prefix=$(PREFIX);make;make install
pcre_installclean : 
	-rm -rf $(call getconfdir,pcre)

nginxuploadmodule_configure : nginxuploadmodule_download
nginxuploadmodule_installclean : 


nginx_configure : nginx_download $(call getconfdir,nginx)/Makefile
	cd $(call getconfdir,nginx);make;make install
$(call getconfdir,nginx)/Makefile : 
	$(eval dirname:=$(call getconfdir,nginx))
	$(eval pcredirname:=$(call getconfdir,pcre))
	$(eval uploadmoddirname:=$(call getconfdir,nginxuploadmodule))
	cd $(dirname);./configure --prefix=$(PREFIX) --with-ipv6 --with-http_ssl_module --without-http_geo_module \
--without-http_map_module --without-http_fastcgi_module --without-http_memcached_module --without-mail_pop3_module \
--without-mail_imap_module --without-mail_smtp_module --without-http_uwsgi_module --without-http_scgi_module \
--without-http_upstream_ip_hash_module --with-pcre=../$(pcredirname) --add-module=../$(uploadmoddirname)
nginx_installclean : 
	-rm -rf $(call getconfdir,nginx)/Makefile

curl_configure : curl_download $(call getconfdir,curl)/config.log
	cd $(call getconfdir,curl);make;make install
$(call getconfdir,curl)/config.log : 
	cd $(call getconfdir,curl);./configure --prefix=$(PREFIX)
curl_installclean : 
	-rm -rf $(call getconfdir,curl)/config.log

p7zip_configure : p7zip_download
	cd $(call getconfdir,p7zip);./configure --prefix=$(PREFIX);make;make install
p7zip_installclean :
	-rm -rf $(call getconfdir,p7zip)

globus_configure : globus_download $(call getconfdir,globus)/Makefile
	$(if $(wildcard $(PREFIX)/etc),,mkdir $(PREFIX)/etc)
	cd $(call getconfdir,globus);C_INCLUDE_PATH=$(C_INCLUDE_PATH) LIBRARY_PATH=$(LIBRARY_PATH) make gpt globus-data-management-client;make install
$(call getconfdir,globus)/Makefile : 
	cd $(call getconfdir,globus);./configure --prefix=$(PREFIX)
globus_installclean : 
	-rm -rf $(call getconfdir,globus)/Makefile

pyconfig=cd $(call getconfdir,$(firstword $(subst _, ,$(1))));python setup.py build;python setup.py install

pyOpenSSL_configure : pyOpenSSL_download
	$(call pyconfig,$@)

apsw_configure : apsw_download
	cd $(call getconfdir,apsw);python setup.py fetch --sqlite;python setup.py build;python setup.py install

lxml_configure : lxml_download
	$(call pyconfig,$@)

pycurl_configure : pycurl_download
	$(call pyconfig,$@)

tornado_configure : tornado_download
	$(call pyconfig,$@)

jsonrpclib_configure : jsonrpclib_download
	$(call pyconfig,$@)

tornadorpc_configure : tornadorpc_download
	$(call pyconfig,$@)

pyuv_configure : pyuv_download
	$(call pyconfig,$@)

pyuvtornado_configure : pyuvtornado_download
	$(call pyconfig,$@)

pygridftp_configure : pygridftp_download
	$(call pyconfig,$@)

coverage_configure : coverage_download
	$(call pyconfig,$@)


iceprod_config : iceprod_base $(ICEPROD)

iceprod_config_core : iceprod_base $(ICEPROD_CORE)

iceprod_base : 
	cd iceprod;python setup.py install

$(ICEPROD) :
	cd $@;python setup.py install

misc_config : 
	cp env-shell.sh $(PREFIX)/env-shell.sh


# echo vars
echo :
	echo $(CONF_DEPS)
	echo $(PYTHON_DEPS)
	echo $(CORE_DEPS)

cmds : 
	echo $(MAKECMDGOALS)


.PHONY : clean distclean installclean exportvars iceprod_base iceprod_config iceprod_config_core $(ICEPROD) $(suffix _configure,$(CONF_DEPS)) $(suffix _configure,$(PYTHON_DEPS))
