

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>iceprod.server.nginx &mdash; IceProd 2.1.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/style.css" type="text/css" />
  

  

  
    <link rel="top" title="IceProd 2.1.1 documentation" href="../../../index.html"/>
        <link rel="up" title="iceprod.server" href="../server.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> IceProd
          

          
          </a>

          
            
            
              <div class="version">
                2.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">IceProd Core</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../server/index.html">IceProd Server</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../details.html">Technical Details</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">IceProd</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div style="float:right">
            <a href="https://github.com/WIPACrepo/iceprod" class="fa fa-github"> Edit on GitHub</a>
          </div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for iceprod.server.nginx</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Nginx is used to handle static content and proxy all other requests to</span>
<span class="sd">the `website module &lt;iceprod.server.modules.website&gt;`_. It also handles</span>
<span class="sd">most of the web security as a SSL/TLS front-end and more generally as</span>
<span class="sd">a hardened attack surface.</span>

<span class="sd">Nginx is easily capable of handling 100+ https connections per second per</span>
<span class="sd">cpu core (on fairly old and weak hardware, at that). It is unlikely to be</span>
<span class="sd">the performance bottleneck.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">crypt</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span><span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">iceprod.core.dataclasses</span> <span class="k">import</span> <span class="n">String</span><span class="p">,</span><span class="n">Number</span><span class="p">,</span><span class="n">Integral</span>
<span class="kn">from</span> <span class="nn">iceprod.server</span> <span class="k">import</span> <span class="n">salt</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;nginx&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="rotate"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.rotate">[docs]</a><span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate a filename.  Useful for log files.&quot;&quot;&quot;</span>
    <span class="c"># move log</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m%d_%H%M%S&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">date</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;cannot rotate, file does not exist: %r&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="deleteoldlogs"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.deleteoldlogs">[docs]</a><span class="k">def</span> <span class="nf">deleteoldlogs</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete old log files&quot;&quot;&quot;</span>
    <span class="c"># delete old logs</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;_*&#39;</span><span class="p">):</span>
        <span class="n">filedate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">filedate</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="find_nginx"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.find_nginx">[docs]</a><span class="k">def</span> <span class="nf">find_nginx</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Locate nginx, if possible.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">&#39;which&#39;</span><span class="p">,</span><span class="s">&#39;nginx&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c"># not on PATH, so search some likely places</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;/usr/sbin&#39;</span><span class="p">,</span><span class="s">&#39;/usr/local/sbin&#39;</span><span class="p">,</span><span class="s">&#39;/sbin&#39;</span><span class="p">):</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;nginx&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pp</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">pp</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Cannot find nginx. Is it installed?&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="find_mime"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.find_mime">[docs]</a><span class="k">def</span> <span class="nf">find_mime</span><span class="p">(</span><span class="n">hints</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locate mime.types file, if possible.&quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/etc/nginx&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="s">&#39;$PWD&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">hints</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hints</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">hints</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">hints</span><span class="o">+</span><span class="n">paths</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;mime.types&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pp</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pp</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;mime.types&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pp</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">pp</span>
    <span class="k">return</span> <span class="k">None</span></div>

<div class="viewcode-block" id="Nginx"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.Nginx">[docs]</a><span class="k">class</span> <span class="nc">Nginx</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around the Nginx webserver.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up Nginx&quot;&quot;&quot;</span>
        <span class="c"># make sure nginx exists</span>
        <span class="n">nginx_path</span> <span class="o">=</span> <span class="n">find_nginx</span><span class="p">()</span>
        <span class="n">mime_path</span> <span class="o">=</span> <span class="n">find_mime</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">nginx_path</span><span class="p">),</span>
                               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">nginx_path</span><span class="p">))])</span>

        <span class="k">if</span> <span class="s">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;prefix&#39;</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="s">&#39;I3PROD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="s">&#39;$I3PROD&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="c"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span>
            <span class="s">&#39;sslcert&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span>
            <span class="s">&#39;sslkey&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span>
            <span class="s">&#39;cacert&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s">&#39;etc/cacerts.crt&#39;</span><span class="p">),</span>
            <span class="s">&#39;request_timeout&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s">&#39;static_dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s">&#39;var/www&#39;</span><span class="p">),</span>
            <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
            <span class="s">&#39;proxy_port&#39;</span><span class="p">:</span><span class="mi">8081</span><span class="p">,</span>
            <span class="s">&#39;pid_file&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s">&#39;var/run/nginx.pid&#39;</span><span class="p">),</span>
            <span class="s">&#39;cfg_file&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s">&#39;etc/nginx.conf&#39;</span><span class="p">),</span>
            <span class="s">&#39;access_log&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s">&#39;var/log/nginx/access.log&#39;</span><span class="p">),</span>
            <span class="s">&#39;error_log&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s">&#39;var/log/nginx/error.log&#39;</span><span class="p">),</span>
            <span class="s">&#39;nginx_bin&#39;</span><span class="p">:</span> <span class="n">nginx_path</span><span class="p">,</span>
            <span class="s">&#39;cache_path&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="s">&#39;var/cache/nginx&#39;</span><span class="p">),</span>
            <span class="s">&#39;mimetypes_file&#39;</span><span class="p">:</span><span class="n">mime_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;str&#39;</span><span class="p">,</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;str&#39;</span><span class="p">,</span>
            <span class="s">&#39;sslcert&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
            <span class="s">&#39;sslkey&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
            <span class="s">&#39;cacert&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
            <span class="s">&#39;request_timeout&#39;</span><span class="p">:</span> <span class="s">&#39;int&#39;</span><span class="p">,</span>
            <span class="s">&#39;static_dir&#39;</span><span class="p">:</span> <span class="s">&#39;dir&#39;</span><span class="p">,</span>
            <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="s">&#39;int&#39;</span><span class="p">,</span>
            <span class="s">&#39;proxy_port&#39;</span><span class="p">:</span> <span class="s">&#39;int&#39;</span><span class="p">,</span>
            <span class="s">&#39;pid_file&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
            <span class="s">&#39;cfg_file&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
            <span class="s">&#39;access_log&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
            <span class="s">&#39;error_log&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
            <span class="s">&#39;nginx_bin&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
            <span class="s">&#39;cache_path&#39;</span><span class="p">:</span> <span class="s">&#39;dir&#39;</span><span class="p">,</span>
            <span class="s">&#39;mimetypes_file&#39;</span><span class="p">:</span> <span class="s">&#39;file&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c"># setup cfg variables</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">String</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;parameter name %s is not a string&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;%s is not a valid arg&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg_types</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;str&#39;</span><span class="p">,</span><span class="s">&#39;file&#39;</span><span class="p">,</span><span class="s">&#39;dir&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">String</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;%s is not a string&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;file&#39;</span><span class="p">,</span><span class="s">&#39;dir&#39;</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s">&#39;_file&#39;</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">or</span> <span class="s">&#39;_log&#39;</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">or</span> <span class="s">&#39;cache&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;parameter %s with filepath %s does not exist&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s">&#39;int&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">Integral</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;%s is not an int&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s">&#39;float&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">Number</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;%s is not a float&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;%s has an unknown type&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;enabling auth_basic&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_basic</span> <span class="o">=</span> <span class="k">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authbasicfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="s">&#39;authbasic.htpasswd&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authbasicfile</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">passwd</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">.</span><span class="n">crypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">salt</span><span class="p">())</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{}:{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;disabling auth_basic&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_basic</span> <span class="o">=</span> <span class="k">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;sslcert&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;sslkey&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;enabling SSL for nginx&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssl</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;disabling SSL for nginx&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssl</span> <span class="o">=</span> <span class="k">False</span>

        <span class="c"># create dirs</span>
        <span class="n">create_dirs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;cfg_file&#39;</span><span class="p">]),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;error_log&#39;</span><span class="p">]),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;access_log&#39;</span><span class="p">]),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;cache_path&#39;</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">create_dirs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c"># write config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfgfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;cfg_file&#39;</span><span class="p">]))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="c"># core nginx options</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;daemon off;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;pid {};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">]))</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;worker_processes 1;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;events {&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  worker_connections 1024;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;error_log {} error;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;error_log&#39;</span><span class="p">]))</span>
            <span class="c"># http options</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;http {&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;mimetypes_file&#39;</span><span class="p">]</span> <span class="ow">and</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;mimetypes_file&#39;</span><span class="p">])):</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  include {};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;mimetypes_file&#39;</span><span class="p">]))</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  default_type application/octet-stream;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ignore_invalid_headers on;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  keepalive_timeout 300;&#39;</span><span class="p">)</span>
            <span class="c"># logging</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  log_format main  </span><span class="se">\&#39;</span><span class="s">$remote_addr $host $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot;</span><span class="se">\&#39;</span><span class="s">;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  access_log {} main buffer=32k;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;access_log&#39;</span><span class="p">]))</span>
            <span class="c"># gzip if possible</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  gzip on;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  gzip_vary on;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  gzip_min_length 1000;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  sendfile off;&#39;</span><span class="p">)</span> <span class="c"># don&#39;t use sendfile because of proxies</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  client_body_temp_path {}/client_body;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;cache_path&#39;</span><span class="p">]))</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  root {}/;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;static_dir&#39;</span><span class="p">]))</span> <span class="c"># direct random queries to static dir</span>
            <span class="c"># ssl options</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl</span> <span class="ow">is</span> <span class="k">True</span><span class="p">:</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ssl on;&#39;</span><span class="p">)</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:AES128-SHA;&#39;</span><span class="p">)</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ssl_prefer_server_ciphers on;&#39;</span><span class="p">)</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;&#39;</span><span class="p">)</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ssl_session_timeout 5m;&#39;</span><span class="p">)</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ssl_certificate {};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;sslcert&#39;</span><span class="p">]))</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ssl_certificate_key {};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;sslkey&#39;</span><span class="p">]))</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;  ssl_client_certificate {};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;cacert&#39;</span><span class="p">]))</span>
            <span class="c"># server options</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  server {&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    listen {:d};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]))</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    access_log {} main buffer=32k;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;access_log&#39;</span><span class="p">]))</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    proxy_connect_timeout 30s;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    proxy_send_timeout 30s;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    proxy_read_timeout 600s;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    proxy_set_header Host $http_host;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    proxy_redirect off;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    proxy_http_version 1.1;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    proxy_next_upstream error;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    proxy_temp_path {}/proxy_temp;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;cache_path&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl</span> <span class="ow">is</span> <span class="k">True</span><span class="p">:</span> <span class="c"># redirect http to https</span>
                <span class="n">p</span><span class="p">(</span><span class="s">&#39;    error_page  497 =307 https://$http_host$request_uri;&#39;</span><span class="p">)</span>
            <span class="c"># static files</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    location /static/ {&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;      alias {}/;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;static_dir&#39;</span><span class="p">]))</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;      index index.html index.htm;&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;      sendfile on;&#39;</span><span class="p">)</span> <span class="c"># turn sendfile on for lower resource usage</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;      max_ranges 1;&#39;</span><span class="p">)</span> <span class="c"># allow partial downloads</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    }&#39;</span><span class="p">)</span>
            <span class="c"># tornado proxy</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    location / {&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;      proxy_pass http://localhost:{:d};&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;proxy_port&#39;</span><span class="p">]))</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;    }&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;  }&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="k">None</span>

<div class="viewcode-block" id="Nginx.start"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.Nginx.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start server&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Nginx already running&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;starting Nginx...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;nginx_bin&#39;</span><span class="p">],</span><span class="s">&#39;-c&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgfile</span><span class="p">])</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Nginx running on %d, proxying to %d&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;proxy_port&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Nginx.stop"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.Nginx.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop server&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;stopping Nginx...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="k">None</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Nginx not running&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Nginx.kill"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.Nginx.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop server&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;killing Nginx...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="k">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Nginx not running&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Nginx.logrotate"><a class="viewcode-back" href="../../../server/nginx.html#iceprod.server.nginx.Nginx.logrotate">[docs]</a>    <span class="k">def</span> <span class="nf">logrotate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rotate log files&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;rotating Nginx log files...&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;access_log&#39;</span><span class="p">])</span>
                <span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;error_log&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">)</span>
                <span class="n">deleteoldlogs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;access_log&#39;</span><span class="p">])</span>
                <span class="n">deleteoldlogs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">[</span><span class="s">&#39;error_log&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error rotating Nginx log files: %r&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Nginx not running&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, IceCube Collaboration.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'2.1.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>