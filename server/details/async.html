

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Asynchronous Programming &mdash; IceProd master documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  
  
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="IceProd master documentation" href="../../index.html"/>
        <link rel="up" title="IceProd Server Details" href="index.html"/>
        <link rel="next" title="Website" href="website.html"/>
        <link rel="prev" title="Global Queueing" href="global_queueing.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> IceProd
          

          
          </a>

          
            
            
              <div class="version">
                2.5.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/index.html">User’s Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide/login.html">Login</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/submission.html">Dataset Submission</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/datasets.html">Dataset Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/tasks.html">Task Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/restapi.html">REST API Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/manually.html">Running Manually</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../admin/index.html">Administrator’s Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../admin/startup.html">Server Startup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../admin/common.html">Common Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../admin/extra_details.html">Extras</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../core/index.html">IceProd Core</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../core/i3exec.html">I3Exec</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/exe.html">Execution Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/exe_helper.html">Execution Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/exe_json.html">JSONRPC Calls</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/jsonRPCclient.html">JSON-RPC Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/jsonUtil.html">JSON Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/init.html">Core Init</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/dataclasses.html">Dataclasses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/parser.html">Meta-Language Parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/serialization.html">Serialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/gridftp.html">GridFTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core/util.html">Utilities</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">IceProd Server</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Server Details</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="submit_to_queue.html">From Submission to Queue</a></li>
<li class="toctree-l3"><a class="reference internal" href="task_relationships.html">Task Relationships</a></li>
<li class="toctree-l3"><a class="reference internal" href="lifecycles.html">Lifecycles</a></li>
<li class="toctree-l3"><a class="reference internal" href="global_queueing.html">Global Queueing</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Asynchronous Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="website.html">Website</a></li>
<li class="toctree-l3"><a class="reference internal" href="auth.html">REST Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="user_accounts.html">User Accounts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rest_api/index.html">REST API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/datasets.html">Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/config.html">Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/jobs.html">Jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/tasks.html">Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/task_stats.html">Task Stats</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/logs.html">Logs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/grids.html">Grids</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/pilots.html">Pilots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rest_api/auth.html">Auth</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../auth.html">Token Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config.html">Detailed Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmethods.html">DB Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../file_io.html">File IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../globus.html">Globus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../grid.html">Grid Queueing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../init.html">Server Init</a></li>
<li class="toctree-l2"><a class="reference internal" href="../module.html">Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nginx.html">Nginx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../schedule.html">Schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../server.html">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../squid.html">Squid</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ssl_cert.html">SSL/TLS Certificate Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tornado.html">Tornado Web Utilities</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IceProd</a>
        
      </nav>


      
      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">IceProd Server</a> &raquo;</li>
        
          <li><a href="index.html">IceProd Server Details</a> &raquo;</li>
        
      <li>Asynchronous Programming</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/server/details/async.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="asynchronous-programming">
<span id="async"></span><h1>Asynchronous Programming<a class="headerlink" href="#asynchronous-programming" title="Permalink to this headline">¶</a></h1>
<div class="section" id="some-background">
<h2>Some Background<a class="headerlink" href="#some-background" title="Permalink to this headline">¶</a></h2>
<p>There has been a large movement in the python community for asynchronous
programming. Examples include Twisted, Tornado, ZeroMQ, pyftpdlib,
libevent, libev, pyev, libuv, wattle, etc. More officially, it has been
accepted into the python standard library as <code class="docutils literal"><span class="pre">asyncio</span></code> as of python 3.4.</p>
<div class="section" id="brief-summary">
<h3>Brief Summary<a class="headerlink" href="#brief-summary" title="Permalink to this headline">¶</a></h3>
<p>Asynchronous programming refers to two related concepts:</p>
<ul>
<li><p class="first">I/O bound scalability, opening multiple socket connections with a
single thread.</p>
<p>This is relevant to the <a class="reference external" href="http://en.wikipedia.org/wiki/C10k_problem">C10k problem</a>,
as a single thread can handle many connections if it does not
wait for remote I/O operations to finish before moving to the next
connection.</p>
</li>
<li><p class="first">Explicit cooperative multi-threading, where yield points are visible
and known.</p>
<p>One relevant quote from Nick Coghlan:</p>
<blockquote>
<div><p>When writing implicitly asynchronous code, you have to assume that you
may lose control of the execution at any point, since even something as
innocuous as retrieving an attribute from an object may suspend the thread
of control. By contrast, with explicitly asynchronous code, it is safe to
assume that you have sole access to shared data structures between
suspension points.</p>
</div></blockquote>
<p>Thus the focus on explicit yield points, which grants “locks” on data without
worrying about the complexities of thread safety.</p>
</li>
</ul>
<p>For IceProd, the first concept is the most important one.  Scalability is one
of the primary goals, so making sure servers can handle thousands of requests
per second is important. The rest of this documentation will focus on that.</p>
<p>Whatever the method of getting asynchronous, the goal is to allow the main
thread to continue processing additional requests while the current request is
processed (or waiting) somewhere else. While this doesn’t work well for
compute-bound applications, network I/O lends itself very well to this because
of the high latencies between network events.  Thus, as long as the main
thread can check for a new request every few microseconds, it can also run a
large number of shorter functions at the same time.</p>
<p>In practice, the main benefit comes when interacting with a filesystem or
database. Both of these actions would normally spend a large number of clock
cycles waiting for a return value, but can now do useful work in the meantime.</p>
</div>
<div class="section" id="notes">
<h3>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h3>
<p>For some deeper reading, see <a class="reference external" href="http://python-notes.curiousefficiency.org/en/latest/pep_ideas/async_programming.html">Nick Coghlan’s thoughts</a>.</p>
<p>Official PEP: <a class="reference external" href="http://python.org/dev/peps/pep-3156">3156</a>.</p>
<p>Documentation: <a class="reference external" href="http://docs.python.org/dev/library/asyncio.html">asyncio</a>.</p>
</div>
</div>
<div class="section" id="practical-usage">
<h2>Practical Usage<a class="headerlink" href="#practical-usage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="callbacks">
<h3>Callbacks<a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h3>
<p>The traditional method of going asynchronous is by <a class="reference external" href="http://en.wikipedia.org/wiki/Asynchronous_I/O#Callback_functions">callback functions</a>.
Instead of waiting for a long function to return, it is instead given a
callback and returns immediately. Eventually the original action will be
finished and call the callback.</p>
<div class="section" id="tornado">
<h4>Tornado<a class="headerlink" href="#tornado" title="Permalink to this headline">¶</a></h4>
<p>IceProd’s main access to asynchronous I/O is through <a class="reference external" href="http://www.tornadoweb.org">Tornado</a>.
This is the basic framework for the website, and provides utility functions
for asynchronous sockets that are used in several other places.  Tornado
also allows us to make http downloads asynchronously.</p>
<p>A basic Hello World example is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="k">import</span> <span class="n">IOLoop</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>

<span class="c1"># Schedule a call to hello_world()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span><span class="n">loop</span><span class="p">))</span>

<span class="c1"># Blocking call interrupted by loop.stop()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="gridftp">
<h4>GridFTP<a class="headerlink" href="#gridftp" title="Permalink to this headline">¶</a></h4>
<p>Using the C API for the <a class="reference external" href="http://www.globus.org/toolkit">Globus Toolkit</a>
allows us to use GridFTP asynchronously as well.  This has been integrated
into Tornado’s callback mechanism in Python with mostly complete pybindings
for ease of use.</p>
</div>
</div>
<div class="section" id="callback-details">
<h3>Callback Details<a class="headerlink" href="#callback-details" title="Permalink to this headline">¶</a></h3>
<p>Functions that accept callbacks generally take the form of:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span><span class="n">arg2</span><span class="p">,</span><span class="n">callback</span><span class="p">):</span>
    <span class="c1"># do some work</span>
    <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>The callback argument should be a function capable of handling the result it
is given.</p>
<p>For I/O applications, it is often necessary to pass connection details to the
callback function.  There are two approaches:</p>
<ol class="arabic">
<li><p class="first">Quick and Dirty:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span><span class="n">callback</span><span class="p">,</span><span class="n">callback_args</span><span class="p">):</span>
    <span class="c1"># do work</span>
    <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">callback_args</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># handle result</span>
<span class="n">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cb</span><span class="p">,{</span><span class="s1">&#39;handle&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">})</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
<div class="line-block">
<div class="line">This passes callback arguments through the worker function using a second argument.  It is used often in lower level languages where things must be compiled to binary before running.</div>
</div>
</div>
<ol class="arabic" start="2">
<li><p class="first">Functional Programming:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span><span class="n">callback</span><span class="p">):</span>
    <span class="c1"># do work</span>
    <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cb</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
    <span class="c1"># handle result</span>
<span class="n">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">partial</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;handle&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">}))</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
<div class="line-block">
<div class="line">In functional programming, function signatures can be changed by filling in only some of the arguments and treating that as a new function.  Python allows this with the <code class="docutils literal"><span class="pre">functools.partial()</span></code> built-in.</div>
</div>
</div>
<p>Much of the code in the IceProd server uses the functional programming
style, though there is some of the first style in the GridFTP python bindings.</p>
</div>
</div>
<div class="section" id="futures">
<h2>Futures<a class="headerlink" href="#futures" title="Permalink to this headline">¶</a></h2>
<p>Starting in python 3.2, and available as a backport with the <code class="docutils literal"><span class="pre">futures</span></code>
package, asynchronous actions have more official support:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Run slow operations in parallel using threads.</span>
<span class="c1"># Instead of taking 5 seconds, this should only take 1 second.</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="k">def</span> <span class="nf">slow_operation</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># make a futures executor that launches 5 worker threads</span>
<span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="c1"># queue the operations</span>
    <span class="n">queue_operations</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">slow_operation</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">queue_operations</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># wait for this one to finish</span>
            <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>
</div>
<p>IceProd already has Tornado to do the heavy lifting that the
<code class="docutils literal"><span class="pre">ThreadPoolExecutor</span></code> would do.  And in fact, it gets even easier.</p>
<p>In the Tornado request handler, where the get or post method is usually
defined, <code class="docutils literal"><span class="pre">tornado.gen.coroutine</span></code> and <code class="docutils literal"><span class="pre">tornado.concurrent.run_on_executor</span></code>
can be used to provide a yield-like syntax for callback functions:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Using Tornado, run slow operations in parallel using threads.</span>
<span class="c1"># Instead of taking 5 seconds, this should only take 1 second.</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.concurrent</span>

<span class="k">class</span> <span class="nc">slow_op</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>

    <span class="c1"># wrap this function such that it returns a Future</span>
    <span class="nd">@tornado</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">run_on_executor</span>
    <span class="k">def</span> <span class="nf">slow_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="k">class</span> <span class="nc">MyHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="c1"># get the global slop_op instance</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ops</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span>

    <span class="c1"># handle Futures inline with yield</span>
    <span class="nd">@tornado</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">slow_operation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>


<span class="c1"># make a futures executor that launches 5 worker threads</span>
<span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>

    <span class="c1"># launch tornado</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
        <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/.*&quot;</span><span class="p">,</span> <span class="n">MyHandler</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ops&#39;</span><span class="p">:</span><span class="n">slow_op</span><span class="p">()}),</span>
    <span class="p">])</span>
    <span class="n">app</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Test this with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">time</span> <span class="o">(</span>curl http://localhost:8888 <span class="p">&amp;</span> curl http://localhost:8888 <span class="p">&amp;</span> curl http://localhost:8888 <span class="p">&amp;</span> curl http://localhost:8888 <span class="p">&amp;</span> curl http://localhost:8888 <span class="p">&amp;</span> <span class="nb">wait</span><span class="o">)</span>
</pre></div>
</div>
<p>Or, if you already have an asynchronous function with a callback, you can use
<code class="docutils literal"><span class="pre">tornado.concurrent.return_future</span></code> to make it return a Future. Note that
the function should be truly asynchronous, with no blocking before the
function returns. Good examples of this are network calls where you expect
the result to be returned in the callback whenever it happens.</p>
</div>
<div class="section" id="id3">
<h2>AsyncIO<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Starting in python 3.4 an asynchronous I/O library has been included in
python. This takes the place of <code class="docutils literal"><span class="pre">tornado</span></code> in some of the previous examples.
A basic Hello World example is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<span class="c1"># Schedule a call to hello_world()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>

<span class="c1"># Blocking call interrupted by loop.stop()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="website.html" class="btn btn-neutral float-right" title="Website" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="global_queueing.html" class="btn btn-neutral" title="Global Queueing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, IceCube Collaboration.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'master',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>