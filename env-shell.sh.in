#!/bin/sh
#
# IceProd environment script.
#
if [ "$1" = "help" ]
    then
    echo "Usage: $0 [SHELL]"
    echo "Spawn a new shell with an IceProd environment loaded"
    echo ""
    echo "SHELL can specified with or without a full path.  If SHELL"
    echo "is omitted the login shell is used by default."
    echo "Examples:"
    echo "   ./env.sh"
    echo "   ./env.sh tcsh"
    echo "   ./env.sh /bin/tcsh"
    echo ""
    echo "To exit the IceProd environment simply exit the new shell."
    echo ""
    exit 1
fi

if [ -z $SHELL ]
    then
    SHELL=@SHELL@
fi

if [ -z "$1" ]
    then # user did not specify a shell
    NEW_SHELL=$SHELL 
    # only exit if no shell specified on command line *and* env already loaded 
    if [ -n "$IP_SHELL" ]
    then
        echo "****************************************************************"
        echo "You are currently in a shell with an IceProd environment loaded."
        echo "Please exit the current shell and re-run $0 from a clean shell."
        echo "****************************************************************"
        echo "Environment not (re)loaded."
        exit 2
    fi
else
    NEW_SHELL=$1
    shift
    ARGV=$*
fi

_I3PROD=@prefix@
_IP_SHELL=$NEW_SHELL
_LD_LIBRARY_PATH=$_I3PROD/lib:$LD_LIBRARY_PATH
_DYLD_LIBRARY_PATH=$_I3PROD/lib:$DYLD_LIBRARY_PATH
_PYTHONPATH=$_I3PROD/lib/python2.7/site-packages:$PYTHONPATH
_PATH=$_I3PROD/bin:$_I3PROD/sbin:$PATH
_MANPATH=$_I3PROD/share/man:$MANPATH
_GLOBUS_LOCATION=$_I3PROD
_X509_CERT_DIR=$_GLOBUS_LOCATION/etc/grid-security/certificates

TOPBAR="************************************************************************"
WIDTH=`echo "$TOPBAR" | wc -c`

WIDTH=$(( $WIDTH-2 ))

printctr()
{
    LEN=`echo "$*" | wc -c`
    LOFFSET=$(( ($WIDTH-$LEN)/2 ))
    ROFFSET=$(( $WIDTH-$LOFFSET-$LEN ))

    FORMAT="*%${LOFFSET}s%s%${ROFFSET}s*\n"
    printf $FORMAT " " "$*" " "
}

if [ -z "$ARGV" ]
    then
    printf "$TOPBAR\n"
    printctr ""
    printctr "W E L C O M E "
    printctr ""
    printctr "@META_PROJECT@ @VERSION@"
    printctr ""
    printf "$TOPBAR\n"
    printf "IceProd environment has:\n"
    printf "   PATH = %s\n" $_PATH
    printf "   LD_LIBRARY_PATH = %s\n" $_LD_LIBRARY_PATH
    printf "   PYTHONPATH = %s\n" $_PYTHONPATH
    printf "   GLOBUS_LOCATION = %s\n" $_GLOBUS_LOCATION
fi

if [ -z "$IP_SHELL" ] # a clean, first invocation
then
    PATH=$_PATH \
    LD_LIBRARY_PATH=$_LD_LIBRARY_PATH \
    DYLD_LIBRARY_PATH=$_DYLD_LIBRARY_PATH \
    PYTHONPATH=$_PYTHONPATH \
    MANPATH=$_MANPATH \
    GLOBUS_LOCATION=$_GLOBUS_LOCATION \
    X509_CERT_DIR=$_X509_CERT_DIR \
    I3PROD=$_I3PROD \
    IP_SHELL=$_IP_SHELL \
    $NEW_SHELL $ARGV

else  # not clean, use previous environment
    $NEW_SHELL $ARGV
fi

STATUS=$?

if [ -z "$ARGV" ]
then
    echo "Exited IceProd Environment."
fi
exit $STATUS
